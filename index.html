<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binance å¤§é¢è®¢å•ç›‘æ§</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; background: #0b1220; color: #e6e9ef; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .card { background: #121a2a; border: 1px solid #1d2a44; border-radius: 10px; padding: 14px; margin-bottom: 14px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .col { flex: 1; min-width: 280px; }
    label { font-size: 12px; color: #9fb0cc; }
    input, select { background: #0f1626; color: #e6e9ef; border: 1px solid #22314f; border-radius: 8px; padding: 10px 12px; width: 100%; box-sizing: border-box; height: 40px; }
    select { appearance: none; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
    .pill.buy { background: #3b1720; color: #ff9aa5; border: 1px solid #7a2434; }
    .pill.sell { background: #14351c; color: #76e0a6; border: 1px solid #1e6a38; }
    .pill.neutral { background: #202a3b; color: #9fb0cc; border: 1px solid #324565; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .kpi { background: #0f1626; border: 1px solid #1d2a44; border-radius: 8px; padding: 10px; }
    .kpi .label { font-size: 12px; color: #9fb0cc; }
    .kpi .value { font-size: 16px; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #1d2a44; font-size: 13px; }
    th { text-align: left; color: #9fb0cc; font-weight: 600; }
    tr:hover td { background: #0f1626; }
    .muted { color: #9fb0cc; }
    .ok { color: #76e0a6; }
    .err { color: #ff9aa5; }
    .hint { font-size: 12px; color: #9fb0cc; }
    .small { font-size: 12px; }
    .sep { height: 1px; background: #1d2a44; margin: 10px 0; }
    .btn { background: #1b59b0; color: white; border: 0; border-radius: 8px; padding: 10px 14px; height: 40px; cursor: pointer; }
    .btn:disabled { background: #253551; cursor: not-allowed; }
    code { color: #9bd1ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸš€ Binance å¤§é¢è®¢å•ç›‘æ§ </h1>
    <div class="row" style="align-items:flex-end;">
      <div class="col">
        <label>äº¤æ˜“å¯¹ï¼ˆç°è´§ä¾‹ï¼š<code>btcusdt</code>ï¼›USDTåˆçº¦ä¾‹ï¼š<code>btcusdt</code>ï¼›å¸æœ¬ä½ä¾‹ï¼š<code>btcusd_perp</code>ï¼‰</label>
        <input id="symbol" value="btcusdt" />
      </div>
      <div class="col">
        <label>å¸‚åœºç±»å‹</label>
        <select id="marketType">
          <option value="spot" selected>ç°è´§</option>
          <option value="usdtm">USDT æœ¬ä½åˆçº¦</option>
          <option value="coinm">å¸æœ¬ä½åˆçº¦</option>
        </select>
      </div>
      <div class="col">
        <label>æ·±åº¦æ¡£ä½</label>
        <select id="depth">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="100">å®Œæ•´æ·±åº¦ï¼ˆ100+ï¼‰</option>
        </select>
      </div>
      <div class="col">
        <label>å¤§å•é˜ˆå€¼ï¼ˆå•ä½ï¼šåŸºç¡€å¸ï¼Œå¦‚ BTCï¼‰</label>
        <input id="threshold" type="number" step="0.1" value="3" />
      </div>
      <div class="col" style="display:flex;align-items:flex-end;gap:8px;">
        <button class="btn" id="connectBtn">è¿æ¥</button>
        <button class="btn" id="resetBtn" style="background:#6b7280;">é‡ç½®ç»Ÿè®¡</button>
        <button class="btn" id="exportBtn" style="background:#2f855a;">å¯¼å‡ºCSV</button>
        <button class="btn" id="clearStorageBtn" style="background:#7a2434;">æ¸…ç©ºæŒä¹…åŒ–</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px; align-items:flex-end;">
      <div class="col">
        <label>è‡ªå®šä¹‰ç½‘å…³ï¼ˆå¯é€‰ï¼Œç”¨äºç§‘å­¦ä¸Šç½‘ï¼Œç¤ºä¾‹ï¼š<code>ws://127.0.0.1:8765/ws</code>ï¼‰</label>
        <input id="gateway" placeholder="ç•™ç©ºåˆ™ç›´è¿ Binance" value="" />
      </div>
      <div class="col">
        <label>ä»£ç†åœ°å€ä¼ ç»™ç½‘å…³ï¼ˆå¯é€‰ï¼Œç¤ºä¾‹ï¼š<code>http://127.0.0.1:7890</code> æˆ– <code>http://host:port</code>ï¼‰</label>
        <input id="gatewayProxy" placeholder="ç•™ç©ºä½¿ç”¨ç½‘å…³é»˜è®¤ä»£ç†æˆ–ç³»ç»Ÿä»£ç†" value="" />
      </div>
    </div>
    <div class="sep"></div>
    <div class="small muted" id="status">æœªè¿æ¥</div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
          <div>
            <span class="pill neutral">å®æ—¶ç»Ÿè®¡</span>
            <span id="pairTitle" class="small muted"></span>
          </div>
          <div>
            <span id="powerBadge" class="pill neutral">âš–ï¸ åŸºæœ¬å‡è¡¡</span>
          </div>
        </div>
        <div class="grid" style="margin-top:10px;">
          <div class="kpi">
            <div class="label">å½“å‰ä¹°å•å¢™ï¼ˆç¬”æ•° / æ€»é‡ / æ€»å€¼$ï¼‰</div>
            <div class="value" id="kpiBid">-</div>
          </div>
          <div class="kpi">
            <div class="label">å½“å‰å–å•å¢™ï¼ˆç¬”æ•° / æ€»é‡ / æ€»å€¼$ï¼‰</div>
            <div class="value" id="kpiAsk">-</div>
          </div>
          <div class="kpi">
            <div class="label">æ•°é‡æ¯”ä¾‹ï¼ˆä¹°:å–ï¼‰</div>
            <div class="value" id="kpiQtyRatio">-</div>
          </div>
          <div class="kpi">
            <div class="label">é‡‘é¢æ¯”ä¾‹ï¼ˆä¹°:å–ï¼‰</div>
            <div class="value" id="kpiValRatio">-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <span class="pill neutral">ğŸ“ˆ çª—å£æœŸæˆäº¤æ±‡æ€»</span>
        <div class="grid" style="margin-top:10px;">
          <div class="kpi"><div class="label">15 åˆ†é’Ÿ</div><div class="value" id="agg15m">-</div></div>
          <div class="kpi"><div class="label">1 å°æ—¶</div><div class="value" id="agg1h">-</div></div>
          <div class="kpi"><div class="label">24 å°æ—¶</div><div class="value" id="agg24h">-</div></div>
          <div class="kpi"><div class="label">48 å°æ—¶</div><div class="value" id="agg48h">-</div></div>
          <div class="kpi"><div class="label">72 å°æ—¶</div><div class="value" id="agg72h">-</div></div>
        </div>
        <div class="small muted" style="margin-top:8px;">æ˜¾ç¤ºæœ€è¿‘çª—å£å†…â€œè¢«åˆ¤å®šæˆäº¤çš„å¤§é¢æŒ‚å•â€çš„ä¹°/å–ç´¯è®¡æ•°é‡ä¸å æ¯”ã€‚</div>
      </div>

      

      <div class="card">
        <span class="pill neutral">ğŸ“œ æœ€è¿‘æˆäº¤è®°å½•ï¼ˆæœ€å¤š 20 æ¡ï¼‰</span>
        <div class="sep"></div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>çŠ¶æ€</th>
              <th>æ–¹å‘</th>
              <th>ä»·æ ¼</th>
              <th>æ•°é‡</th>
              <th>æˆäº¤æ—¶é—´</th>
              <th>å­˜ç»­(ç§’)</th>
            </tr>
          </thead>
          <tbody id="historyTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <span class="pill sell">ğŸŸ¢ å½“å‰å–å•å¢™ï¼ˆå‰ 10ï¼‰</span>
        <div class="sep"></div>
        <table>
          <thead>
            <tr>
              <th>ä»·æ ¼</th>
              <th>æ•°é‡</th>
              <th>æŒç»­(ç§’)</th>
            </tr>
          </thead>
          <tbody id="asksTbody"></tbody>
        </table>
      </div>
      <div class="card">
        <span class="pill buy">ğŸ”´ å½“å‰ä¹°å•å¢™ï¼ˆå‰ 10ï¼‰</span>
        <div class="sep"></div>
        <table>
          <thead>
            <tr>
              <th>ä»·æ ¼</th>
              <th>æ•°é‡</th>
              <th>æŒç»­(ç§’)</th>
            </tr>
          </thead>
          <tbody id="bidsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // é…ç½®ä¸æ•°æ®ç»“æ„ï¼ˆä¸ Python ç‰ˆä¿æŒä¸€è‡´æ€æƒ³ï¼‰
    let ws = null;
    let trackedOrders = {}; // key: bid_ä»·æ ¼ / ask_ä»·æ ¼ -> { side, price, qty, firstSeen, lastSeen, status }
    let orderHistory = [];  // æˆäº¤è®°å½•ï¼ˆæ¶ˆå¤±å³è®¤ä¸ºæˆäº¤ï¼‰
    let currentSymbol = 'btcusdt';
    const MAX_HISTORY_DISPLAY = 20;
    const windows = [
      { id: 'agg15m', label: '15m', spanSec: 15 * 60 },
      { id: 'agg1h',  label: '1h',  spanSec: 60 * 60 },
      { id: 'agg24h', label: '24h', spanSec: 24 * 60 * 60 },
      { id: 'agg48h', label: '48h', spanSec: 48 * 60 * 60 },
      { id: 'agg72h', label: '72h', spanSec: 72 * 60 * 60 },
    ];
    const statsHistory = []; // ç”¨äºç®€å•è¶‹åŠ¿ï¼ˆå¯é€‰ï¼‰
    const MAX_STATS_HISTORY = 60; // çº¦ 1 åˆ†é’Ÿ

    // DOM å¼•ç”¨
    const elStatus = document.getElementById('status');
    const elPairTitle = document.getElementById('pairTitle');
    const elPowerBadge = document.getElementById('powerBadge');
    const elKpiBid = document.getElementById('kpiBid');
    const elKpiAsk = document.getElementById('kpiAsk');
    const elKpiQtyRatio = document.getElementById('kpiQtyRatio');
    const elKpiValRatio = document.getElementById('kpiValRatio');
    const elBidsTbody = document.getElementById('bidsTbody');
    const elAsksTbody = document.getElementById('asksTbody');
    const elHistoryTbody = document.getElementById('historyTbody');
    

    function nowSec() { return Math.floor(Date.now() / 1000); }
    function fmt(n, d = 2) { return Number(n).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d }); }
    function fmtTs(s) { return new Date(s * 1000).toLocaleString(); }

    function buildBinanceWsUrl(symbol, depth, marketType) {
      const s = symbol.trim().toLowerCase();
      let base;
      if (marketType === 'usdtm') base = 'wss://fstream.binance.com/ws';
      else if (marketType === 'coinm') base = 'wss://dstream.binance.com/ws';
      else base = 'wss://stream.binance.com:9443/ws'; // spot
      if ([5,10,20].includes(Number(depth))) {
        return `${base}/${s}@depth${depth}@100ms`;
      }
      return `${base}/${s}@depth@100ms`;
    }

    function resetAll(opts = { keepHistory: false }) {
      trackedOrders = {};
      if (!opts.keepHistory) {
        orderHistory = [];
      }
      statsHistory.length = 0;
      renderAll({});
    }

    function getStorageKey(symbol) { return `orderMonitorHistory_v1:${symbol.trim().toLowerCase()}`; }
    function loadHistoryFromStorage(symbol) {
      try {
        const raw = localStorage.getItem(getStorageKey(symbol));
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          // ç¡®ä¿æŒ‰æ—¶é—´å€’åºï¼ˆæœ€è¿‘åœ¨å‰ï¼‰
          arr.sort((a,b) => (b.filled_time_sec||0) - (a.filled_time_sec||0));
          orderHistory = arr;
        }
      } catch (e) { /* å¿½ç•¥ */ }
    }
    function saveHistoryToStorage(symbol) {
      try {
        // æ§åˆ¶ä¸Šé™ï¼Œé¿å…æ— é™è†¨èƒ€ï¼ˆä¾‹å¦‚ 200k æ¡ï¼Œå¯è‡ªè¡Œè°ƒæ•´ï¼‰
        const cap = 200000;
        const data = orderHistory.slice(0, cap);
        localStorage.setItem(getStorageKey(symbol), JSON.stringify(data));
      } catch (e) { /* å¯èƒ½è¶…é…é¢ï¼Œå¿½ç•¥ */ }
    }

    function connect(isReconnect = false) {
      const connectBtn = document.getElementById('connectBtn');
      connectBtn.disabled = true;
      try {
        const symbol = document.getElementById('symbol').value.trim();
        const depth = document.getElementById('depth').value;
        const marketType = document.getElementById('marketType').value;
        const threshold = Number(document.getElementById('threshold').value || 0);
        const gateway = (document.getElementById('gateway').value || '').trim();
        const gatewayProxy = (document.getElementById('gatewayProxy').value || '').trim();

        if (!symbol) {
          elStatus.innerHTML = `<span class="err">è¯·è¾“å…¥äº¤æ˜“å¯¹ï¼ˆå¦‚ btcusdtï¼‰</span>`;
          connectBtn.disabled = false;
          return;
        }

        // è‡ªåŠ¨é‡è¿ï¼šä¿ç•™å†å²ä¸ç»Ÿè®¡å±•ç¤ºï¼›é¦–æ¬¡/æ‰‹åŠ¨è¿æ¥ï¼šå®Œå…¨é‡ç½®
        if (isReconnect) {
          resetAll({ keepHistory: true });
        } else {
          resetAll({ keepHistory: false });
        }
        currentSymbol = symbol;
        loadHistoryFromStorage(symbol);
        const binanceUrl = buildBinanceWsUrl(symbol, depth, marketType);
        const url = gateway
          ? `${gateway}?target=${encodeURIComponent(binanceUrl)}${gatewayProxy ? `&proxy=${encodeURIComponent(gatewayProxy)}` : ''}`
          : binanceUrl;
        const marketLabel = marketType === 'usdtm' ? 'USDTåˆçº¦' : (marketType === 'coinm' ? 'å¸æœ¬ä½åˆçº¦' : 'ç°è´§');
        elPairTitle.textContent = `${symbol.toUpperCase()} Â· ${marketLabel} @ æ·±åº¦ ${depth}`;
        elStatus.textContent = `è¿æ¥ä¸­ï¼š${url}`;

        // åŠ è½½åˆ°æœ¬åœ°å†å²åç«‹å³æ¸²æŸ“ï¼Œé¿å…æ–­çº¿æœŸé—´é¡µé¢ç©ºç™½
        renderAll({ symbol, threshold });

        try { if (ws) ws.close(); } catch (_) {}
        ws = new WebSocket(url);

        ws.onopen = () => {
          elStatus.innerHTML = `<span class="ok">âœ… å·²è¿æ¥</span> <span class=\"muted small\">é˜ˆå€¼ â‰¥ ${threshold} ${symbol.slice(0, -4).toUpperCase()}</span>`;
          connectBtn.disabled = false;
        };

        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            // ç°è´§: bids/asksï¼›åˆçº¦: b/a
            const bids = (marketType === 'spot') ? (data.bids || data.b || []) : (data.b || data.bids || []);
            const asks = (marketType === 'spot') ? (data.asks || data.a || []) : (data.a || data.asks || []);
            updateOrderTracking(bids, asks, threshold);
            renderAll({ symbol, threshold });
          } catch (e) {
            // JSON è§£æå¤±è´¥å¿½ç•¥
          }
        };

        ws.onerror = (e) => {
          elStatus.innerHTML = `<span class=\"err\">âŒ WebSocket é”™è¯¯ï¼š${e?.message || 'è¯·æ£€æŸ¥ç½‘ç»œ/ä»£ç†/ç½‘å…³'}</span>`;
          connectBtn.disabled = false;
        };

        ws.onclose = () => {
          elStatus.innerHTML = `<span class=\"muted\">ğŸ”Œ å·²æ–­å¼€ï¼Œ5 ç§’åå°è¯•é‡è¿...</span>`;
          connectBtn.disabled = false;
          setTimeout(() => connect(true), 5000);
        };
      } catch (err) {
        elStatus.innerHTML = `<span class=\"err\">âŒ è¿æ¥åˆå§‹åŒ–å¤±è´¥ï¼š${(err && err.message) || err}</span>`;
        connectBtn.disabled = false;
      }
    }

    // å¤åˆ»æ ¸å¿ƒï¼šè·Ÿè¸ªè¾¾åˆ°é˜ˆå€¼çš„ä»·ä½ï¼Œå¦‚æœè¯¥ä»·ä½åœ¨ä¸‹ä¸€æ¬¡å¿«ç…§ä¸­æ¶ˆå¤±ï¼Œåˆ™è®¤ä¸ºæˆäº¤
    function updateOrderTracking(bids, asks, threshold) {
      const t = nowSec();
      const current = {};

      // å¤„ç†ä¹°å•
      for (const [priceStr, qtyStr] of bids) {
        const price = parseFloat(priceStr);
        const qty = parseFloat(qtyStr);
        if (qty >= threshold) {
          const key = `bid_${price}`;
          current[key] = true;
          if (!trackedOrders[key]) {
            trackedOrders[key] = { side: 'ğŸ”´ ä¹°å•', price, qty, firstSeen: t, lastSeen: t, status: 'æŒ‚å•ä¸­' };
          } else {
            trackedOrders[key].qty = qty;
            trackedOrders[key].lastSeen = t;
          }
        }
      }

      // å¤„ç†å–å•
      for (const [priceStr, qtyStr] of asks) {
        const price = parseFloat(priceStr);
        const qty = parseFloat(qtyStr);
        if (qty >= threshold) {
          const key = `ask_${price}`;
          current[key] = true;
          if (!trackedOrders[key]) {
            trackedOrders[key] = { side: 'ğŸŸ¢ å–å•', price, qty, firstSeen: t, lastSeen: t, status: 'æŒ‚å•ä¸­' };
          } else {
            trackedOrders[key].qty = qty;
            trackedOrders[key].lastSeen = t;
          }
        }
      }

      // åˆ¤æ–­æ¶ˆå¤±ï¼ˆæˆäº¤ï¼‰
      for (const [key, o] of Object.entries(trackedOrders)) {
        if (o.status === 'æŒ‚å•ä¸­' && !current[key]) {
          const duration = t - o.firstSeen;
          const filled = {
            side: o.side,
            price: o.price,
            qty: o.qty,
            first_seen: o.firstSeen,
            filled_time_sec: t,
            filled_time: fmtTs(t),
            duration,
            status: 'âœ… å·²æˆäº¤',
          };
          orderHistory.unshift(filled);
          // åªä¿ç•™å¯è§†éœ€è¦çš„æ•°é‡
          if (orderHistory.length > 5000) orderHistory.length = 5000;
          // åŒæ­¥æŒä¹…åŒ–ï¼ˆè¿½åŠ åœ¨å‰ï¼‰
          saveHistoryToStorage(currentSymbol);
          delete trackedOrders[key];
        }
      }
    }

    function aggregateWindows() {
      const t = nowSec();
      const res = {};
      for (const w of windows) {
        const from = t - w.spanSec;
        let buyCnt = 0, sellCnt = 0, buyQty = 0, sellQty = 0;
        for (const o of orderHistory) {
          if (o.filled_time_sec >= from) {
            if ((o.side || '').includes('ä¹°')) { buyCnt++; buyQty += Number(o.qty) || 0; }
            else if ((o.side || '').includes('å–')) { sellCnt++; sellQty += Number(o.qty) || 0; }
          } else {
            // å› ä¸ºæ˜¯æŒ‰æ—¶é—´å€’åºæ’å…¥ï¼Œå¯æå‰ç»“æŸ
            break;
          }
        }
        const totalCnt = buyCnt + sellCnt;
        const pctBuy = totalCnt ? (buyCnt / totalCnt * 100) : 0;
        const pctSell = totalCnt ? (sellCnt / totalCnt * 100) : 0;
        res[w.id] = {
          html: `ä¹° ${fmt(buyQty)} / å– ${fmt(sellQty)}<br/>ç¬”æ•° ä¹°${buyCnt} vs å–${sellCnt}<br/>æˆäº¤å æ¯” ä¹°${fmt(pctBuy,1)}% vs å–${fmt(pctSell,1)}%`,
          buyQty, sellQty, buyCnt, sellCnt
        };
      }
      return res;
    }

    function renderRealtimeKPIs() {
      const activeBids = Object.values(trackedOrders).filter(o => o.status === 'æŒ‚å•ä¸­' && (o.side || '').includes('ä¹°'));
      const activeAsks = Object.values(trackedOrders).filter(o => o.status === 'æŒ‚å•ä¸­' && (o.side || '').includes('å–'));
      const totalBidQty = activeBids.reduce((s, o) => s + (Number(o.qty) || 0), 0);
      const totalAskQty = activeAsks.reduce((s, o) => s + (Number(o.qty) || 0), 0);
      const totalBidVal = activeBids.reduce((s, o) => s + (Number(o.qty) * Number(o.price) || 0), 0);
      const totalAskVal = activeAsks.reduce((s, o) => s + (Number(o.qty) * Number(o.price) || 0), 0);

      // æœ€å¤§å•ç¬” & å¹³å‡ä»·ï¼ˆå¯é€‰å±•ç¤ºåœ¨æ–‡æœ¬ä¸­ï¼‰
      const maxBid = activeBids.length ? activeBids.reduce((a, b) => (a.qty >= b.qty ? a : b)) : null;
      const maxAsk = activeAsks.length ? activeAsks.reduce((a, b) => (a.qty >= b.qty ? a : b)) : null;
      const avgBid = activeBids.length ? activeBids.reduce((s, o) => s + Number(o.price), 0) / activeBids.length : 0;
      const avgAsk = activeAsks.length ? activeAsks.reduce((s, o) => s + Number(o.price), 0) / activeAsks.length : 0;

      elKpiBid.textContent = `${activeBids.length} / ${fmt(totalBidQty)} / $${fmt(totalBidVal)}${maxBid ? ` | æœ€å¤§ ${fmt(maxBid.qty)} @ $${fmt(maxBid.price)} | å‡ä»· $${fmt(avgBid)}` : ''}`;
      elKpiAsk.textContent = `${activeAsks.length} / ${fmt(totalAskQty)} / $${fmt(totalAskVal)}${maxAsk ? ` | æœ€å¤§ ${fmt(maxAsk.qty)} @ $${fmt(maxAsk.price)} | å‡ä»· $${fmt(avgAsk)}` : ''}`;

      if (totalBidQty > 0 && totalAskQty > 0) {
        const qtyRatio = totalBidQty / totalAskQty;
        elKpiQtyRatio.textContent = `${fmt(qtyRatio, 2)} : 1`;
        if (qtyRatio > 1.5) setBadge('buy', 'ğŸ”´ ä¹°ç›˜å ä¼˜');
        else if (qtyRatio < 0.67) setBadge('sell', 'ğŸŸ¢ å–ç›˜å ä¼˜');
        else setBadge('neutral', 'âš–ï¸ åŸºæœ¬å‡è¡¡');
      } else {
        elKpiQtyRatio.textContent = '-';
        setBadge('neutral', 'âš–ï¸ åŸºæœ¬å‡è¡¡');
      }

      if (totalBidVal > 0 && totalAskVal > 0) {
        const valRatio = totalBidVal / totalAskVal;
        elKpiValRatio.textContent = `${fmt(valRatio, 2)} : 1`;
      } else {
        elKpiValRatio.textContent = '-';
      }

      // è®°å½•ç®€æ˜“è¶‹åŠ¿å†å²
      statsHistory.push({ t: nowSec(), bidQty: totalBidQty, askQty: totalAskQty });
      if (statsHistory.length > MAX_STATS_HISTORY) statsHistory.shift();

      // æ¸²æŸ“åˆ—è¡¨ï¼šä¹°å•å¢™/å–å•å¢™
      const byPriceDesc = [...activeBids].sort((a,b) => b.price - a.price).slice(0, 10);
      const byPriceAsc  = [...activeAsks].sort((a,b) => a.price - b.price).slice(0, 10);
      elBidsTbody.innerHTML = byPriceDesc.map(o => `<tr><td>$${fmt(o.price)}</td><td>${fmt(o.qty)}</td><td>${fmt(nowSec() - o.firstSeen, 1)}</td></tr>`).join('');
      elAsksTbody.innerHTML = byPriceAsc.map(o => `<tr><td>$${fmt(o.price)}</td><td>${fmt(o.qty)}</td><td>${fmt(nowSec() - o.firstSeen, 1)}</td></tr>`).join('');
    }

    function setBadge(kind, text) {
      elPowerBadge.className = 'pill ' + (kind === 'buy' ? 'buy' : kind === 'sell' ? 'sell' : 'neutral');
      elPowerBadge.textContent = text;
    }

    function renderWindowsAgg() {
      const agg = aggregateWindows();
      for (const w of windows) {
        const el = document.getElementById(w.id);
        if (el && agg[w.id]) el.innerHTML = agg[w.id].html;
      }
    }

    function renderHistory() {
      const rows = orderHistory.slice(0, MAX_HISTORY_DISPLAY).map((o, i) => {
        return `<tr>
          <td>${i+1}</td>
          <td>âœ… å·²æˆäº¤</td>
          <td>${o.side}</td>
          <td>$${fmt(o.price)}</td>
          <td>${fmt(o.qty)}</td>
          <td>${o.filled_time}</td>
          <td>${fmt(o.duration, 1)}</td>
        </tr>`;
      }).join('');
      elHistoryTbody.innerHTML = rows;
    }

    function renderAll(ctx) {
      renderRealtimeKPIs();
      renderWindowsAgg();
      renderHistory();
    }


    // å¯¼å‡º CSVï¼ˆå½“å‰äº¤æ˜“å¯¹çš„å…¨éƒ¨å†å²ï¼‰
    function exportCSV() {
      const header = ['çŠ¶æ€','æ–¹å‘','ä»·æ ¼','æ•°é‡','æˆäº¤æ—¶é—´','å­˜ç»­(ç§’)'];
      const lines = [header.join(',')];
      for (const o of orderHistory) {
        lines.push([
          'å·²æˆäº¤',
          (o.side||'').replace(/[,\n]/g,' '),
          o.price,
          o.qty,
          o.filled_time,
          o.duration
        ].join(','));
      }
      const blob = new Blob(['\ufeff' + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentSymbol}_order_history.csv`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }

    function clearPersistent() {
      try { localStorage.removeItem(getStorageKey(currentSymbol)); } catch (e) {}
      // ä¸æ¸…ç©ºå†…å­˜ä¸­çš„å†å²ï¼Œç•™ç»™ç”¨æˆ·è‡ªè¡Œ â€œé‡ç½®ç»Ÿè®¡â€ æ§åˆ¶
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('connectBtn').addEventListener('click', () => connect());
    document.getElementById('resetBtn').addEventListener('click', () => resetAll());
    document.getElementById('exportBtn').addEventListener('click', () => exportCSV());
    document.getElementById('clearStorageBtn').addEventListener('click', () => { clearPersistent(); alert('å·²æ¸…ç©ºå½“å‰äº¤æ˜“å¯¹çš„æŒä¹…åŒ–å†å²'); });

    // é¡µé¢åˆæ¬¡åŠ è½½è‡ªåŠ¨è¿æ¥
    connect();
  </script>
</body>
</html>


