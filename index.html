<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binance å¤§é¢è®¢å•ç›‘æ§</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 12px; background: #0b1220; color: #e6e9ef; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    .card { background: #121a2a; border: 1px solid #1d2a44; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    .card-windows { min-height: 320px; }
    @media (max-width: 768px) {
      body { margin: 6px; }
      .card { padding: 8px; margin-bottom: 8px; border-radius: 6px; }
      .card-windows { min-height: 480px; }
      h1 { font-size: 18px; margin: 0 0 4px; }
      .row { gap: 6px; }
      .col { min-width: 200px; }
      #status { min-height: 28px; max-height: 28px; font-size: 10px; }
      a[href="3min.html"] { font-size: 11px; padding: 3px 6px; }
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start; }
    .col { flex: 1; min-width: 280px; }
    label { font-size: 11px; color: #9fb0cc; margin-bottom: 4px; }
    input, select { background: #0f1626; color: #e6e9ef; border: 1px solid #22314f; border-radius: 6px; padding: 8px 10px; width: 100%; box-sizing: border-box; height: 36px; }
    select { appearance: none; }
    .pill { display: inline-block; padding: 2px 7px; border-radius: 999px; font-size: 11px; margin-right: 4px; }
    .pill.buy { background: #3b1720; color: #ff9aa5; border: 1px solid #7a2434; }
    .pill.sell { background: #14351c; color: #76e0a6; border: 1px solid #1e6a38; }
    .pill.neutral { background: #202a3b; color: #9fb0cc; border: 1px solid #324565; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .kpi { background: #0f1626; border: 1px solid #1d2a44; border-radius: 6px; padding: 8px; min-height: 80px; display: flex; flex-direction: column; overflow: hidden; }
    .kpi .label { font-size: 11px; color: #9fb0cc; }
    .kpi .value { font-size: 13px; margin-top: 4px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; word-break: break-word; line-height: 1.35; }
    .kpi-window { min-height: 85px; }
    .kpi-chart { min-height: 120px; }
    .chart-bar-container { margin-top: 8px; height: 30px; background: #0f1626; border-radius: 4px; overflow: hidden; display: flex; }
    .chart-bar { height: 100%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; }
    .chart-bar.buy { background: linear-gradient(90deg, #7a2434, #ff9aa5); color: #fff; }
    .chart-bar.sell { background: linear-gradient(90deg, #1e6a38, #76e0a6); color: #fff; }
    .chart-legend { margin-top: 6px; display: flex; gap: 12px; font-size: 11px; }
    .chart-legend-item { display: flex; align-items: center; gap: 4px; }
    .chart-legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    .chart-legend-dot.buy { background: #ff9aa5; }
    .chart-legend-dot.sell { background: #76e0a6; }
    @media (max-width: 768px) {
      .kpi { min-height: 125px; padding: 6px; }
      .kpi-window { min-height: 145px; }
      .kpi-chart { min-height: 140px; }
      .kpi .value { font-size: 10.5px; line-height: 1.25; margin-top: 3px; }
      .kpi .label { font-size: 10px; }
      .grid { gap: 6px; }
      input, select { height: 34px; padding: 6px 8px; font-size: 13px; }
      .btn { height: 34px; padding: 6px 10px; font-size: 12px; }
      #thresholdOp { width: 70px !important; font-size: 12px; }
      .pill { font-size: 10px; padding: 2px 5px; }
      label { font-size: 10px; margin-bottom: 2px; }
      .sep { margin: 3px 0; }
      .small { font-size: 10px; }
      .chart-bar { font-size: 10px; }
      .chart-legend { font-size: 10px; gap: 8px; }
    }
    .muted { color: #9fb0cc; }
    .ok { color: #76e0a6; }
    .err { color: #ff9aa5; }
    .hint { font-size: 11px; color: #9fb0cc; }
    .small { font-size: 11px; }
    .sep { height: 1px; background: #1d2a44; margin: 6px 0; }
    #status { min-height: 32px; max-height: 32px; overflow: hidden; display: flex; align-items: center; line-height: 1.4; white-space: nowrap; }
    .btn { background: #1b59b0; color: white; border: 0; border-radius: 6px; padding: 8px 12px; height: 36px; cursor: pointer; font-size: 13px; }
    .btn:disabled { background: #253551; cursor: not-allowed; }
    code { color: #9bd1ff; }
    a[href="3min.html"] { transition: all 0.2s ease; }
    a[href="3min.html"]:hover { background: #1b59b0; border-color: #1b59b0; color: white; }
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
      <h1 style="margin:0;">ğŸš€ Binance å¤§é¢è®¢å•ç›‘æ§ </h1>
      <a href="3min.html" style="color:#9bd1ff;text-decoration:none;font-size:12px;padding:4px 8px;border:1px solid #22314f;border-radius:4px;background:#0f1626;">ğŸ“Š 3åˆ†é’Ÿè§†å›¾</a>
    </div>
    <div class="row" style="align-items:flex-end;">
      <div class="col">
        <label>äº¤æ˜“å¯¹ï¼ˆç°è´§ä¾‹ï¼š<code>btcusdt</code>ï¼›USDTåˆçº¦ä¾‹ï¼š<code>btcusdt</code>ï¼›å¸æœ¬ä½ä¾‹ï¼š<code>btcusd_perp</code>ï¼‰</label>
        <input id="symbol" value="btcusdt" />
      </div>
      <div class="col">
        <label>å¸‚åœºç±»å‹</label>
        <select id="marketType">
          <option value="spot">ç°è´§</option>
          <option value="usdtm" selected>USDT æœ¬ä½åˆçº¦</option>
          <option value="coinm">å¸æœ¬ä½åˆçº¦</option>
        </select>
      </div>
      <div class="col">
        <label>æ·±åº¦æ¡£ä½</label>
        <select id="depth">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="100">å®Œæ•´æ·±åº¦ï¼ˆ100+ï¼‰</option>
        </select>
      </div>
      <div class="col">
        <label>å¤§å•é˜ˆå€¼ï¼ˆå•ä½ï¼šåŸºç¡€å¸ï¼Œå¦‚ BTCï¼‰</label>
        <div style="display:flex;gap:6px;">
          <select id="thresholdOp" style="width:80px;flex-shrink:0;">
            <option value="gt" selected>å¤§äº</option>
            <option value="lt">å°äº</option>
          </select>
          <input id="threshold" type="number" step="0.1" value="3" style="flex:1;" />
        </div>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;gap:6px;">
        <button class="btn" id="connectBtn">è¿æ¥</button>
        <button class="btn" id="resetBtn" style="background:#6b7280;">é‡ç½®ç»Ÿè®¡</button>
        <button class="btn" id="clearStorageBtn" style="background:#7a2434;">æ¸…ç©ºæŒä¹…åŒ–</button>
      </div>
      <div class="col" style="display:flex;align-items:center;gap:6px;">
        <label style="display:flex;align-items:center;gap:4px;margin:0;cursor:pointer;">
          <input type="checkbox" id="autoReconnect" checked style="width:auto;height:auto;margin:0;">
          <span style="font-size:12px;">è‡ªåŠ¨é‡è¿</span>
        </label>
      </div>
    </div>
    <div class="row" style="margin-top:6px; align-items:flex-end;">
      <div class="col">
        <label>è‡ªå®šä¹‰ç½‘å…³ï¼ˆå¯é€‰ï¼Œç”¨äºç§‘å­¦ä¸Šç½‘ï¼Œç¤ºä¾‹ï¼š<code>ws://127.0.0.1:8765/ws</code>ï¼‰</label>
        <input id="gateway" placeholder="ç•™ç©ºåˆ™ç›´è¿ Binance" value="" />
      </div>
      <div class="col">
        <label>ä»£ç†åœ°å€ä¼ ç»™ç½‘å…³ï¼ˆå¯é€‰ï¼Œç¤ºä¾‹ï¼š<code>http://127.0.0.1:7890</code> æˆ– <code>http://host:port</code>ï¼‰</label>
        <input id="gatewayProxy" placeholder="ç•™ç©ºä½¿ç”¨ç½‘å…³é»˜è®¤ä»£ç†æˆ–ç³»ç»Ÿä»£ç†" value="" />
      </div>
    </div>
    <div class="sep"></div>
    <div class="small muted" id="status">æœªè¿æ¥</div>
  </div>

  <div class="card card-windows">
    <div style="display:flex;align-items:center;gap:6px;justify-content:space-between;margin-bottom:6px;">
      <div>
        <span class="pill neutral">ğŸ“ˆ çª—å£æœŸæˆäº¤æ±‡æ€»</span>
        <span id="pairTitle" class="small muted"></span>
      </div>
    </div>
    <div class="grid" style="margin-top:6px;">
      <div class="kpi kpi-chart" style="grid-column: 1 / -1;">
        <div class="label">15 åˆ†é’Ÿ</div>
        <div class="chart-bar-container" id="chart15m">
          <div class="chart-bar buy" style="width: 50%;">ä¹° 0</div>
          <div class="chart-bar sell" style="width: 50%;">å– 0</div>
        </div>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-dot buy"></span>
            <span id="legend15mBuy">ä¹°å•: 0 (0%)</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-dot sell"></span>
            <span id="legend15mSell">å–å•: 0 (0%)</span>
          </div>
        </div>
      </div>
      <div class="kpi kpi-window"><div class="label">1 å°æ—¶</div><div class="value" id="agg1h">-</div></div>
    </div>
    <div class="small muted" style="margin-top:4px;">æ˜¾ç¤ºæœ€è¿‘çª—å£å†…"è¢«åˆ¤å®šæˆäº¤çš„å¤§é¢æŒ‚å•"çš„ä¹°/å–ç´¯è®¡æ•°é‡ä¸å æ¯”ã€‚</div>
  </div>

  <script>
    // é…ç½®ä¸æ•°æ®ç»“æ„ï¼ˆä¸ Python ç‰ˆä¿æŒä¸€è‡´æ€æƒ³ï¼‰
    let ws = null;
    let trackedOrders = {}; // key: bid_ä»·æ ¼ / ask_ä»·æ ¼ -> { side, price, qty, firstSeen, lastSeen, status }
    let orderHistory = [];  // æˆäº¤è®°å½•ï¼ˆæ¶ˆå¤±å³è®¤ä¸ºæˆäº¤ï¼‰
    let currentSymbol = 'btcusdt';
    let lastMessageTime = 0; // æœ€åæ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´
    let heartbeatInterval = null; // å¿ƒè·³æ£€æµ‹å®šæ—¶å™¨
    const windows = [
      { id: 'agg15m', label: '15m', spanSec: 15 * 60 },
      { id: 'agg1h',  label: '1h',  spanSec: 60 * 60 },
    ];

    // DOM å¼•ç”¨
    const elStatus = document.getElementById('status');
    const elPairTitle = document.getElementById('pairTitle');
    

    function nowSec() { return Math.floor(Date.now() / 1000); }
    function fmt(n, d = 2) { return Number(n).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d }); }
    function fmtTs(s) { return new Date(s * 1000).toLocaleString(); }

    function buildBinanceWsUrl(symbol, depth, marketType) {
      const s = symbol.trim().toLowerCase();
      let base;
      if (marketType === 'usdtm') base = 'wss://fstream.binance.com/ws';
      else if (marketType === 'coinm') base = 'wss://dstream.binance.com/ws';
      else base = 'wss://stream.binance.com:9443/ws'; // spot
      if ([5,10,20].includes(Number(depth))) {
        return `${base}/${s}@depth${depth}@100ms`;
      }
      return `${base}/${s}@depth@100ms`;
    }

    function resetAll(opts = { keepHistory: false }) {
      trackedOrders = {};
      if (!opts.keepHistory) {
        orderHistory = [];
      }
      try {
        renderAll({});
      } catch (e) {
        console.error('æ¸²æŸ“é”™è¯¯:', e);
      }
    }

    function getStorageKey(symbol) { return `orderMonitorHistory_v1:${symbol.trim().toLowerCase()}`; }
    function loadHistoryFromStorage(symbol) {
      try {
        const raw = localStorage.getItem(getStorageKey(symbol));
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          // ç¡®ä¿æŒ‰æ—¶é—´å€’åºï¼ˆæœ€è¿‘åœ¨å‰ï¼‰ï¼Œå¹¶åªä¿ç•™1å°æ—¶å†…çš„è®°å½•
          const oneHourAgo = nowSec() - 60 * 60;
          const filtered = arr.filter(o => (o.filled_time_sec || 0) >= oneHourAgo);
          filtered.sort((a,b) => (b.filled_time_sec||0) - (a.filled_time_sec||0));
          orderHistory = filtered;
        }
      } catch (e) { /* å¿½ç•¥ */ }
    }
    function saveHistoryToStorage(symbol) {
      try {
        // åªä¿å­˜1å°æ—¶å†…çš„è®°å½•ï¼Œé‡Šæ”¾å†…å­˜
        const oneHourAgo = nowSec() - 60 * 60;
        const data = orderHistory.filter(o => (o.filled_time_sec || 0) >= oneHourAgo);
        localStorage.setItem(getStorageKey(symbol), JSON.stringify(data));
      } catch (e) { /* å¯èƒ½è¶…é…é¢ï¼Œå¿½ç•¥ */ }
    }

    function connect(isReconnect = false) {
      const connectBtn = document.getElementById('connectBtn');
      connectBtn.disabled = true;
      try {
        const symbol = document.getElementById('symbol').value.trim();
        const depth = document.getElementById('depth').value;
        const marketType = document.getElementById('marketType').value;
        const threshold = Number(document.getElementById('threshold').value || 0);
        const thresholdOp = document.getElementById('thresholdOp').value || 'gt';
        const gateway = (document.getElementById('gateway').value || '').trim();
        const gatewayProxy = (document.getElementById('gatewayProxy').value || '').trim();

        if (!symbol) {
          elStatus.innerHTML = `<span class="err">è¯·è¾“å…¥äº¤æ˜“å¯¹ï¼ˆå¦‚ btcusdtï¼‰</span>`;
          connectBtn.disabled = false;
          return;
        }

        // è‡ªåŠ¨é‡è¿ï¼šä¿ç•™å†å²ä¸ç»Ÿè®¡å±•ç¤ºï¼›é¦–æ¬¡/æ‰‹åŠ¨è¿æ¥ï¼šå®Œå…¨é‡ç½®
        if (isReconnect) {
          resetAll({ keepHistory: true });
        } else {
          resetAll({ keepHistory: false });
        }
        currentSymbol = symbol;
        loadHistoryFromStorage(symbol);
        const binanceUrl = buildBinanceWsUrl(symbol, depth, marketType);
        const url = gateway
          ? `${gateway}?target=${encodeURIComponent(binanceUrl)}${gatewayProxy ? `&proxy=${encodeURIComponent(gatewayProxy)}` : ''}`
          : binanceUrl;
        const marketLabel = marketType === 'usdtm' ? 'USDTåˆçº¦' : (marketType === 'coinm' ? 'å¸æœ¬ä½åˆçº¦' : 'ç°è´§');
        elPairTitle.textContent = `${symbol.toUpperCase()} Â· ${marketLabel} @ æ·±åº¦ ${depth}`;
        // ç¼©çŸ­URLæ˜¾ç¤ºï¼Œé¿å…æ¢è¡Œå¯¼è‡´è·³åŠ¨
        const shortUrl = url.length > 80 ? url.substring(0, 80) + '...' : url;
        elStatus.innerHTML = `<span>è¿æ¥ä¸­...</span>`;
        elStatus.title = url; // å®Œæ•´URLæ˜¾ç¤ºåœ¨æ‚¬åœæç¤ºä¸­

        // åŠ è½½åˆ°æœ¬åœ°å†å²åç«‹å³æ¸²æŸ“ï¼Œé¿å…æ–­çº¿æœŸé—´é¡µé¢ç©ºç™½
        renderAll({ symbol, threshold });

        try { if (ws) ws.close(); } catch (_) {}
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        
        ws = new WebSocket(url);

        ws.onopen = () => {
          const opSymbol = thresholdOp === 'lt' ? 'â‰¤' : 'â‰¥';
          elStatus.innerHTML = `<span class="ok">âœ… å·²è¿æ¥</span> <span class=\"muted small\">é˜ˆå€¼ ${opSymbol} ${threshold} ${symbol.slice(0, -4).toUpperCase()}</span>`;
          connectBtn.disabled = false;
          lastMessageTime = Date.now();
          
          // å¯åŠ¨å¿ƒè·³æ£€æµ‹ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
          heartbeatInterval = setInterval(() => {
            const now = Date.now();
            const timeSinceLastMsg = (now - lastMessageTime) / 1000;
            if (timeSinceLastMsg > 60) {
              console.warn(`è¶…è¿‡60ç§’æœªæ”¶åˆ°æ•°æ®ï¼Œä¸»åŠ¨æ–­å¼€é‡è¿`);
              if (ws) ws.close();
            }
          }, 30000);
        };

        let messageCount = 0;
        ws.onmessage = (ev) => {
          lastMessageTime = Date.now(); // æ›´æ–°æœ€åæ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´
          messageCount++;
          
          try {
            const data = JSON.parse(ev.data);
            // è·å–å½“å‰å¸‚åœºç±»å‹ï¼ˆæ¯æ¬¡æ¶ˆæ¯éƒ½é‡æ–°è·å–ï¼Œé¿å…é—­åŒ…é—®é¢˜ï¼‰
            const currentMarketType = document.getElementById('marketType').value;
            
            // Binanceæ·±åº¦æ•°æ®æ ¼å¼å¤„ç†
            let bids = [];
            let asks = [];
            
            if (currentMarketType === 'spot') {
              // ç°è´§ä¼˜å…ˆä½¿ç”¨ bids/asks
              bids = data.bids || data.b || [];
              asks = data.asks || data.a || [];
            } else {
              // USDTæœ¬ä½åˆçº¦å’Œå¸æœ¬ä½åˆçº¦ä¼˜å…ˆä½¿ç”¨ b/aï¼ˆæ·±åº¦æ›´æ–°æ ¼å¼ï¼‰
              bids = data.b || data.bids || [];
              asks = data.a || data.asks || [];
            }
            
            // åŠ¨æ€è·å–é˜ˆå€¼å’Œæ“ä½œç¬¦ï¼Œå…è®¸è¿è¡Œæ—¶ä¿®æ”¹
            const currentThreshold = Number(document.getElementById('threshold').value || 0);
            const currentThresholdOp = document.getElementById('thresholdOp').value || 'gt';
            updateOrderTracking(bids, asks, currentThreshold, currentThresholdOp);
            
            // æ¯æ¬¡éƒ½æ¸²æŸ“ï¼Œä¿æŒæ•°æ®å®æ—¶æ€§ï¼ˆçª—å£æœŸæ±‡æ€»é¡µé¢æ•°æ®é‡å°ï¼Œä¸éœ€è¦é™åˆ¶æ¸²æŸ“é¢‘ç‡ï¼‰
            renderAll({ symbol, threshold: currentThreshold });
          } catch (e) {
            console.error('æ¶ˆæ¯å¤„ç†é”™è¯¯:', e);
          }
        };

        ws.onerror = (e) => {
          console.error('WebSocket é”™è¯¯:', e);
          elStatus.innerHTML = `<span class=\"err\">âŒ è¿æ¥é”™è¯¯</span>`;
          elStatus.title = e?.message || 'è¯·æ£€æŸ¥ç½‘ç»œ/ä»£ç†/ç½‘å…³';
          connectBtn.disabled = false;
        };

        ws.onclose = (e) => {
          if (heartbeatInterval) clearInterval(heartbeatInterval);
          console.log('WebSocket å…³é—­:', {
            code: e.code,
            reason: e.reason,
            wasClean: e.wasClean,
            messageCount: messageCount,
            symbol: symbol
          });
          
          let reason = e.reason || '';
          let displayMsg = '';
          
          // ä¼˜åŒ–æ˜¾ç¤ºæ–‡æ¡ˆï¼Œä¸è¦å“äºº
          if (e.code === 1005 && messageCount > 10) {
            // è¿™æ˜¯æ­£å¸¸çš„æœåŠ¡å™¨åˆ·æ–°ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
            displayMsg = 'ğŸ”„ åˆ·æ–°è¿æ¥ä¸­...';
            reason = `æœåŠ¡å™¨å®šæœŸåˆ·æ–°(å·²æ”¶${messageCount}æ¡æ¶ˆæ¯)`;
          } else if (e.code === 1000) {
            displayMsg = 'ğŸ”„ é‡æ–°è¿æ¥ä¸­...';
            reason = 'æ­£å¸¸å…³é—­';
          } else if (e.code === 1006) {
            displayMsg = 'ğŸ”„ é‡æ–°è¿æ¥ä¸­...';
            reason = 'ç½‘ç»œæ³¢åŠ¨';
          } else {
            displayMsg = 'ğŸ”„ é‡æ–°è¿æ¥ä¸­...';
            reason = e.reason || `ä»£ç ${e.code}`;
          }
          
          const autoReconnect = document.getElementById('autoReconnect').checked;
          
          if (autoReconnect) {
            elStatus.innerHTML = `<span class=\"muted\">${displayMsg}</span>`;
            elStatus.title = `${reason}ï¼Œ2ç§’åè‡ªåŠ¨é‡è¿`;
            setTimeout(() => connect(true), 2000);  // æ”¹æˆ2ç§’
          } else {
            elStatus.innerHTML = `<span class=\"err\">â¸ï¸ å·²æš‚åœ</span>`;
            elStatus.title = `${reason}ã€‚è‡ªåŠ¨é‡è¿å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»è¿æ¥`;
          }
          
          connectBtn.disabled = false;
          
          // é‡ç½®æ¶ˆæ¯è®¡æ•°
          messageCount = 0;
        };
      } catch (err) {
        elStatus.innerHTML = `<span class=\"err\">âŒ åˆå§‹åŒ–å¤±è´¥</span>`;
        elStatus.title = (err && err.message) || err || 'æœªçŸ¥é”™è¯¯';
        connectBtn.disabled = false;
      }
    }

    // å¤åˆ»æ ¸å¿ƒï¼šè·Ÿè¸ªè¾¾åˆ°é˜ˆå€¼çš„ä»·ä½ï¼Œå¦‚æœè¯¥ä»·ä½åœ¨ä¸‹ä¸€æ¬¡å¿«ç…§ä¸­æ¶ˆå¤±ï¼Œåˆ™è®¤ä¸ºæˆäº¤
    function updateOrderTracking(bids, asks, threshold, thresholdOp = 'gt') {
      const t = nowSec();
      const current = {};
      
      // æ ¹æ®æ“ä½œç¬¦é€‰æ‹©æ¯”è¾ƒå‡½æ•°
      const compareFn = thresholdOp === 'lt' 
        ? (qty, threshold) => qty <= threshold  // å°äºç­‰äºé˜ˆå€¼
        : (qty, threshold) => qty >= threshold; // å¤§äºç­‰äºé˜ˆå€¼ï¼ˆé»˜è®¤ï¼‰

      // å¤„ç†ä¹°å•
      for (const [priceStr, qtyStr] of bids) {
        const price = parseFloat(priceStr);
        const qty = parseFloat(qtyStr);
        if (compareFn(qty, threshold)) {
          const key = `bid_${price}`;
          current[key] = true;
          if (!trackedOrders[key]) {
            trackedOrders[key] = { side: 'ğŸ”´ ä¹°å•', price, qty, firstSeen: t, lastSeen: t, status: 'æŒ‚å•ä¸­' };
          } else {
            trackedOrders[key].qty = qty;
            trackedOrders[key].lastSeen = t;
          }
        }
      }

      // å¤„ç†å–å•
      for (const [priceStr, qtyStr] of asks) {
        const price = parseFloat(priceStr);
        const qty = parseFloat(qtyStr);
        if (compareFn(qty, threshold)) {
          const key = `ask_${price}`;
          current[key] = true;
          if (!trackedOrders[key]) {
            trackedOrders[key] = { side: 'ğŸŸ¢ å–å•', price, qty, firstSeen: t, lastSeen: t, status: 'æŒ‚å•ä¸­' };
          } else {
            trackedOrders[key].qty = qty;
            trackedOrders[key].lastSeen = t;
          }
        }
      }

      // åˆ¤æ–­æ¶ˆå¤±ï¼ˆæˆäº¤ï¼‰
      for (const [key, o] of Object.entries(trackedOrders)) {
        if (o.status === 'æŒ‚å•ä¸­' && !current[key]) {
          const duration = t - o.firstSeen;
          const filled = {
            side: o.side,
            price: o.price,
            qty: o.qty,
            first_seen: o.firstSeen,
            filled_time_sec: t,
            filled_time: fmtTs(t),
            duration,
            status: 'âœ… å·²æˆäº¤',
          };
          orderHistory.unshift(filled);
          // æ¸…ç†è¶…è¿‡1å°æ—¶çš„è®°å½•ï¼Œé‡Šæ”¾å†…å­˜
          const oneHourAgo = nowSec() - 60 * 60;
          orderHistory = orderHistory.filter(o => (o.filled_time_sec || 0) >= oneHourAgo);
          // åŒæ­¥æŒä¹…åŒ–ï¼ˆè¿½åŠ åœ¨å‰ï¼‰
          saveHistoryToStorage(currentSymbol);
          delete trackedOrders[key];
        }
      }
    }

    function aggregateWindows() {
      const t = nowSec();
      const res = {};
      for (const w of windows) {
        const from = t - w.spanSec;
        let buyCnt = 0, sellCnt = 0, buyQty = 0, sellQty = 0;
        for (const o of orderHistory) {
          if (o.filled_time_sec >= from) {
            if ((o.side || '').includes('ä¹°')) { buyCnt++; buyQty += Number(o.qty) || 0; }
            else if ((o.side || '').includes('å–')) { sellCnt++; sellQty += Number(o.qty) || 0; }
          } else {
            // å› ä¸ºæ˜¯æŒ‰æ—¶é—´å€’åºæ’å…¥ï¼Œå¯æå‰ç»“æŸ
            break;
          }
        }
        const totalCnt = buyCnt + sellCnt;
        const pctBuy = totalCnt ? (buyCnt / totalCnt * 100) : 0;
        const pctSell = totalCnt ? (sellCnt / totalCnt * 100) : 0;
        res[w.id] = {
          html: `ä¹° ${fmt(buyQty)} / å– ${fmt(sellQty)}<br/>ç¬”æ•° ä¹°${buyCnt} vs å–${sellCnt}<br/>æˆäº¤å æ¯” ä¹°${fmt(pctBuy,1)}% vs å–${fmt(pctSell,1)}%`,
          buyQty, sellQty, buyCnt, sellCnt
        };
      }
      return res;
    }


    function renderWindowsAgg() {
      const agg = aggregateWindows();
      for (const w of windows) {
        if (w.id === 'agg15m') {
          // 15åˆ†é’Ÿç”¨å›¾å½¢åŒ–æ˜¾ç¤º
          const data = agg[w.id];
          if (data) {
            const total = data.buyQty + data.sellQty;
            const buyPct = total > 0 ? (data.buyQty / total * 100) : 50;
            const sellPct = total > 0 ? (data.sellQty / total * 100) : 50;
            
            const chartContainer = document.getElementById('chart15m');
            if (chartContainer) {
              const buyBar = chartContainer.querySelector('.chart-bar.buy');
              const sellBar = chartContainer.querySelector('.chart-bar.sell');
              if (buyBar && sellBar) {
                buyBar.style.width = buyPct + '%';
                sellBar.style.width = sellPct + '%';
                buyBar.textContent = total > 0 ? `ä¹° ${fmt(buyPct, 1)}%` : 'ä¹° 0%';
                sellBar.textContent = total > 0 ? `å– ${fmt(sellPct, 1)}%` : 'å– 0%';
              }
            }
            
            const legendBuy = document.getElementById('legend15mBuy');
            const legendSell = document.getElementById('legend15mSell');
            if (legendBuy) legendBuy.textContent = `ä¹°å•: ${fmt(data.buyQty, 1)} (${fmt(buyPct, 1)}%) Â· ${data.buyCnt}ç¬”`;
            if (legendSell) legendSell.textContent = `å–å•: ${fmt(data.sellQty, 1)} (${fmt(sellPct, 1)}%) Â· ${data.sellCnt}ç¬”`;
          }
        } else {
          // å…¶ä»–æ—¶é—´çª—å£ä¿æŒæ–‡å­—æ˜¾ç¤º
          const el = document.getElementById(w.id);
          if (el && agg[w.id]) el.innerHTML = agg[w.id].html;
        }
      }
    }

    function renderAll(ctx) {
      renderWindowsAgg();
    }


    function clearPersistent() {
      try { localStorage.removeItem(getStorageKey(currentSymbol)); } catch (e) {}
      // ä¸æ¸…ç©ºå†…å­˜ä¸­çš„å†å²ï¼Œç•™ç»™ç”¨æˆ·è‡ªè¡Œ "é‡ç½®ç»Ÿè®¡" æ§åˆ¶
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('connectBtn').addEventListener('click', () => connect());
    document.getElementById('resetBtn').addEventListener('click', () => resetAll());
    document.getElementById('clearStorageBtn').addEventListener('click', () => { clearPersistent(); alert('å·²æ¸…ç©ºå½“å‰äº¤æ˜“å¯¹çš„æŒä¹…åŒ–å†å²'); });

    // é¡µé¢åˆæ¬¡åŠ è½½è‡ªåŠ¨è¿æ¥
    connect();
  </script>
</body>
</html>


